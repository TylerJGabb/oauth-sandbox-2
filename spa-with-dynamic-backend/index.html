<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auth0 PKCE Login</title>
</head>
<body>
  <label for="audience">Audience: </label>
  <input id="audience" type="text" value="https://contacts.example.com" size="40" />
  <br><br>
  <button id="loginBtn">Start Login</button>

  <script>
    const enc = new TextEncoder();
    const base64url = buf => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    const rand = (n = 32) => base64url(crypto.getRandomValues(new Uint8Array(n)));
    async function sha256(str) {
      const data = enc.encode(str)
      const digest = await crypto.subtle.digest('SHA-256', data)
      return base64url(digest)
    }
    async function startLogin() {
      const domain = "udemy-tenant-tg.us.auth0.com";
      const clientId = "gxDR1J8157EUO02GB7CM0yqWnyzBEQOF";
      const redirectUri = "http://localhost:8080/";
      const scope = "openid profile email";
      const audience = document.getElementById("audience").value;

      const state = rand(16);
      const verifier = rand(64);
      const challenge = await sha256(verifier);

      sessionStorage.setItem('pkce_state', state);
      sessionStorage.setItem('pkce_verifier', verifier);

      const params = new URLSearchParams({
        response_type: 'code',
        code_challenge_method: 'S256',
        code_challenge: challenge,
        client_id: clientId,
        redirect_uri: redirectUri,
        scope,
        state,
        audience
      });

      window.location = `https://${domain}/authorize?${params}`;
    }

    document.getElementById('loginBtn').addEventListener('click', startLogin);

    // Handle callback if code is present
    (function handleCallback() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const state = url.searchParams.get('state');
      if (!code) return;
      const expectedState = sessionStorage.getItem('pkce_state');
      const verifier = sessionStorage.getItem('pkce_verifier');
      if (state !== expectedState) return;
      const qp = new URLSearchParams({
        code,
        verifier,
        redirectUri: "http://localhost:8080/"
      });

      window.location = `/oauth-exchange?${qp}`;
    })();
  </script>
</body>
</html>
